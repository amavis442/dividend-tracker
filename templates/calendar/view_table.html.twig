{% extends 'base.html.twig' %}

{% block title %}Calendar per date
{% endblock %}

{% block body %}
	<div class="container mb-2 p-3">
		<div class="border p-2">
			<div>
				<h3>Dividend payments per date for
					{{ year }}
				</h3>
				<small class="text-muted">({{'Current date'|trans }}:
					{{ date()|format_date('full') }})</small>
			</div>
		</div>
	</div>

	<div class="container mb-2 p-3">
		<div class="border p-2">

		<section>
			{{ form_start(form) }}
			<div class="row g-3">
				<div class="col-auto">
					{{ form_widget(form.startdate) }}
				</div>
				<div class="col-auto">
					{{ form_widget(form.enddate) }}
				</div>
				<div class="col-auto">
					{{ form_widget(form.pie) }}
				</div>

				<div class="col-auto">
					<button type="submit" class="btn btn-secondary mb-2">
						<i class="fas fa-solid fa-filter"></i>
					</button>
				</div>
			</div>
			{{ form_end(form) }}
		<section>

		<section>
			{% if calendars %}
				<table class="table table-striped">
					<thead>
						<tr>
							<th scope="col"></th>
							<th scope="col">{{ 'Pay date'|trans }}</th>
							<th scope="col">{{ 'Company'|trans }}</th>
							<th scope="col">{{ 'Dividend'|trans }}</th>
							<th scope="col">{{ 'Net dividend'|trans }}</th>
						</tr>
					</thead>
					<tbody>
						{% for month,items in calendars %}
							{% set sumDividend = 0.0 %}
							{% set numPositions = 1 %}
							<tr class="table-dark">
								<th>#</th>
								<th colspan="5">
									{% set chosenDate = month|slice(0,4) ~ '-' ~ month|slice(4,2) ~ '-01' %}
									{{ chosenDate|date('F')|trans }},
									{{ month|slice(0,4) }}
								</th>
							</tr>
							{% for day, item in items %}
								{% for key, calData in item %}
									{% set cal = calData.calendar %}
									{% set netDividend = calData.positionDividend %}
									{% set estimatedAmount = calData.positionAmount %}
									{% set currentDate = cal.getPaymentDate %}
									<tr>
										<td>{{ numPositions}}</td>
										<th>
											{{ currentDate|date('l')|trans }},
											{{ currentDate|date('d') }}
											{{ currentDate|date('F')|trans|lower }}
											{{ currentDate|date('Y') }}</th>
										<td>
											{% set tickerInfo  = '' %}
											{% set tickerInfo %}
											<h3>Ticker:
												{{ calData.ticker }}</h3>
											{{ 'Tax rate'|trans }}:
											{{ calData.taxRate * 100 }}%
											<br/>
											{{ 'Exchangerate'|trans }}:
											{{ calData.exchangeRate|format_number({fraction_digit: 4}) }}<br/>
											{{ 'Tax'|trans }}: &euro;{{ (calData.tax * estimatedAmount)|format_number({fraction_digit: 2}) }}<br/>
											Ex-div:
											<span class='badge text-bg-info'>
												{{ calData.calendar.exDividendDate|date('D, d-m-Y')|format_date('full',locale='nl') }}
											</span>
											{% endset %}
											{% if cal.ticker.positions[0] %}
												<a href="{{ path('portfolio_show', {id: cal.ticker.positions[0].id}) }}">{{ cal.ticker.fullname }}</a>
											{% else %}
												{{ cal.ticker.fullname }}
											{% endif %}
											<span data-controller="popper">
											<i class="fas fa-info-circle"
												data-popper-target="element"
												data-action="mouseenter->popper#show mouseleave->popper#hide"></i>
												<div id="tooltip" role="tooltip" data-popper-target="tooltip">
                       								{{ tickerInfo|raw }}
                        							<div id="arrow" data-popper-target="tooltipArrow"></div>
                    							</div>
											</span>
											<br/>
											<small>{{ estimatedAmount|format_number({fraction_digit: 7}) }}
												{{ 'shares'|trans }}</small>
										</td>
										<td>
											{{ cal.currency.sign|raw}}{{ cal.cashAmount|format_number({fraction_digit: 2}) }}
										</td>
										<td>&euro;{{ netDividend|format_number({fraction_digit: 2}) }}</td>
									</tr>
									{% set sumDividend = sumDividend + netDividend %}
									{% set numPositions = numPositions  + 1 %}
								{% endfor %}
							{% endfor %}
							<tr>
								<td colspan="3"></td>
								<th>{{ 'Total'|trans }}</th>
								<th>&euro;{{ sumDividend|format_number({fraction_digit: 2}) }}</th>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			{% else %}
				no items
			{% endif %}
		</section>


			<a href="{{ path('calendar_index') }}" class="btn btn-primary">
				<i class="fas fa-angle-double-left"></i>
				{{ 'back to list'|trans }}
			</a>
		</div>
	</div>
{% endblock %}
